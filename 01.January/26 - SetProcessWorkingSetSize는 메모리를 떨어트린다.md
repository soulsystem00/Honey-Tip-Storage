# SetProcessWorkingSetSize는 메모리를 떨어트린다

음</br>
결론부터 말하자면</br>
메모리 누수를 잡는데는 실패했음</br>
</br>
일단 인게임에서 누수가 있는지 없는지는 불확실함</br>
아마 있는 걸로 추정됨 왜냐하면 테스트 진행했을 때 누수가 발견되었기 때문임</br>
그런데 이것이 코드 상의 오류로 인한 누수인지가 불확실함</br>
만약에 코드 상에서 발생하는 누수라면 열심히 프로파일러 돌려가면서 해결해야겠지만</br>
단순히 머터리얼이나 텍스쳐 같은 것들이 쌓이는 것이라면</br>

```
Resources.UnloadUnusedAssets();
GC.Collect();
```

이런 함수를 사용해서 해결이 가능할 거임</br>
당연히 이 함수를 넣어서 테스트를 진행했는데도 누수는 계속 발생이 되었고</br>
그래서 계속해서 그 원인을 찾기위해 테스트 진행을 했는데</br>
원인을 찾기가 굉장히 어려웠음</br>
왜냐하면 프로파일러 상으로는 누수가 없었기 때문임</br>
</br>
중간 중간 누수가 생긴 부분들이 있었는데</br>
첫번째로는 프로젝트 자체에서 발생한 누수였고</br>
두번째로는 내가 디버깅을 하다가 추가한 코드 땜에 발생한 누수였음</br>
이 오류들은 프로파일러로 감지가 가능해서 그나마 쉽게 잡았음</br>
</br>
그런데 이렇게 잡았음에도 불구하고</br>
메모리 누수는 계속해서 일어나고 있었고</br>
프로파일러에는 전혀 잡히지 않는 모습을 볼 수 있었음</br>
</br>
이러한 누수는 한 판당 20&#126;40mb 정도로 발생했고</br>
극한으로 테스트 진행을 하면 상당히 많은 메모리가 쌓이는 걸 확인 할 수 있었는데</br>
프로파일러에서는 잡히질 않으니깐 그냥 메모리 증가하는 것만 보면서</br>
테스트 진행을 했음</br>
</br>
그러다가 중간에 메모리가 급격하게 증가하는 순간이 있었는데</br>
해당 구간을 위주로 살펴보니깐</br>
그 쪽에서 메모리 누수가 일어난다는 것을 알 수 있었고</br>
해당 부분 위주로 테스트 진행을 하니깐</br>
확실히 그 부분에서 메모리 누수가 난다는 걸 발견 할 수 있었음</br>
</br>
해당 부분에서 대충 200mb정도 메모리가 증가하게 되는데</br>
그 부분을 지나면 다시 200mb가 사라지던가</br>
사라지지 않는다면 그냥 그 상태가 유지되던가 해야하는데</br>
그게 아리나 증가한 양과 감소된 양이 차이가 발생했고</br>
그게 대략 20~40mb 정도 였음</br>
</br>
아무튼 누수가 발생한 부분을 찾았으니</br>
이제 원인을 찾을 차례였는데</br>
계속 테스트를 해본 결과</br>
결국 DLL에서 누수가 발생한다는 것을 확인할 수 있었음</br>
</br>
켰을 때 DLL 함수를 사용하는데</br>
그러면서 메모리가 확 증가하고</br>
껐을 때도 DLL 함수를 사용하는데</br>
이때 메모리가 감소를 하게 되는데</br>
둘 중 어디선가 메모리 해제가 안되고 계속해서 남아있게 된 것임</br>
</br>
굉장히 여러가지 방법으로 테스트를 진행했고</br>
아무래도 이것 말고는 이전까지 모든 테스트 결과가 설명이 안되기도 함</br>
</br>
아무튼 문제점은</br>
DLL에서 누수가 발생하기 때문에 이걸 해결할 수 없다는 것이었음</br>
DLL이 내가 만든 것도 아니고 다른 사람이 만든 DLL을 갖다 쓰는건데</br>
수정을 할 수도 없고 대체할 수도 없기 때문임</br>
</br>
그래서 결국 이것저것 방법을 찾다가</br>
`SetProcessWorkingSetSize` 함수를 발견하게 되었음</br>
</br>
이걸 사용을 하니깐 메모리가 확 줄어드는 걸 볼 수 있었음</br>
이렇게 줄어드는게 그냥 줄어드는 것도 아니고</br>
몇백메가 차지하고 있던 메모리가 한 자리 수로 줄어들었음</br>
</br>
이렇게까지 줄어들 줄은 몰랐는데</br>
이렇게까지 줄어드니깐 오히려 불안하기도 했음</br>
</br>
아무튼 대충 원리는 당장 사용하는 것 빼고는 싹다 털어버린다고 함</br>
대충 메모리에 올라가있는 것들은 프로그램에서 사용하고 사용할 것들이 올라가져 있을 텐데</br>
당장 사용하는 것 말고는 싹다 빼버리면</br>
결국 다시 불러와야하고 이것은 성능에 영향을 미치게 됨</br>
</br>
그런데 결국 사용하는 순간 불러와야 하기 때문에</br>
성능에 영향을 미칠 수 밖에 없을 거임</br>
그런데 누수로 발생한 더미는 이후에 사용을 하지 않을거니깐</br>
불러와지지 않을 거고 이게 어느정도 효과를 주는 것 같음</br>
</br>
</br>
이건 결국엔 해결책이 아님</br>
결국 메모리 누수를 해결하진 못했음</br>
게다가 이건 메모리를 일단 싹다 반납시키기 때문에</br>
이후의 행동에 있어서도 불안하기도 함</br>
</br>
이를테면 당장 메모리가 점유하고 있는 공간이 부족해져서</br>
메모리 부족에 관한 오류를 발생시킬 수도 있는거고</br>
혹은 크래시가 발생하지 않을까 하는 생각도 듬</br>
</br>
결국엔 메모리 누수가 발생하면 그 원인을 찾아서 해결해야하는건데</br>
이번에는 해결하지 못하는 부분에서 누수가 발생해버려서</br>
어쩔 수 없이 이 함수를 쓸수밖에 없는 상황이 된 것 같음</br>
</br>
</br>
</br>
</br>
</br>
### 잡담
```
이 함수에 대해선 말이 많은 것 같음

메모리 누수 해결방법이라는 사람도 있고
페이크라는 사람도 있고

근데 아무리봐도 메모리 누수 해결방법은 아닌 것 같고
그냥 임시 방편에 불과한 것 같음

만약에 장시간 돌려야하는 프로그램이 있을 때
메모리 증가로 인한 강제종료 같은 것을 방지하기 위한
일종의 수명연장 방법 정도라는 생각이 들었음

결국에 중요한 건 메모리 누수가 발생하면
해당 원인을 찾고 원인을 제거해야 함
너무 이 함수에 의존하면 안될 것 같음
```
